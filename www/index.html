<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta.3/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/speechtotext.css">
  <link rel="stylesheet" href="css/Footer-with-social-icons.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
  <title>iCane</title>
</head>
<body>

<!-- Navbar -->
<nav class="navbar fixed-bottom navbar-expand-sm navbar-light bg-light">
 <!--  <a class="navbar-brand" href="#">iCane</a> -->

    <ul class="navbar-nav mr-auto">
      <li class="nav-item active">
        <a class="nav-link" href="/index.html"><i class="fa fa-home" aria-hidden="true"></i> Home</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/about.html"><i class="fa fa-user" aria-hidden="true"></i> About</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/debug.html"><i class="fa fa-bug" aria-hidden="true"></i> Debug</a>
      </li>
    </ul>

</nav>

<!-- <div class="pop">
  <button type="button" class="btn btn-secondary" data-container="body" data-toggle="popover" data-placement="top" data-content="Vivamus sagittis lacus vel augue laoreet rutrum faucibus.">
    Popover on top
  </button>
</div> -->

<header>
  <h1>Welcome to iCane</h1>
</header>

<!-- Map -->
<div id="map" style="width:80%;height:400px;background:yellow;display:block;margin:auto;margin-top:30px;margin-bottom:20px;"></div>

<!-- Debugging -->
<div id="accordion" role="tablist">
  <div class="card">
    <div class="card-header" role="tab" id="headingOne">
      <h5 class="mb-0">
        <a data-toggle="collapse" href="#collapseOne" role="button" aria-expanded="true" aria-controls="collapseOne">
          Text to Speech
        </a>
      </h5>
    </div>

    <div id="collapseOne" class="collapse show" role="tabpanel" aria-labelledby="headingOne" data-parent="#accordion">
      <div class="card-body">
        <div id="speech-to-text">
          <div id="page-wrapper">
          <h1>Points of Interest</h1>

          <p id="msg"></p>

          <input type="text" name="speech-msg" id="speech-msg" x-webkit-speech>

          <div class="option">
            <label for="voice">Voice</label>
            <select name="voice" id="voice"></select>
          </div>
          <div class="option">
            <label for="volume">Volume</label>
            <input type="range" min="0" max="1" step="0.1" name="volume" id="volume" value="1">
          </div>
          <div class="option">
            <label for="rate">Rate</label>
            <input type="range" min="0.1" max="10" step="0.1" name="rate" id="rate" value="1">
          </div>
          <div class="option">
            <label for="pitch">Pitch</label>
            <input type="range" min="0" max="2" step="0.1" name="pitch" id="pitch" value="1">
          </div>

          <button id="speak">Speak</button>
        <!--
          <div class="row">
            <div class="col-md-6">
              <button id="info" href="">Info</button>
            </div>
            <div class="col-md-6">
              <button id="restroom">Restroom</button>
            </div>
          </div>
         -->
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-header" role="tab" id="headingTwo">
      <h5 class="mb-0">
        <a class="collapsed" data-toggle="collapse" href="#collapseTwo" role="button" aria-expanded="false" aria-controls="collapseTwo">
          Beacons Information
        </a>
      </h5>
    </div>
    <div id="collapseTwo" class="collapse" role="tabpanel" aria-labelledby="headingTwo" data-parent="#accordion">
      <div class="card-body">
        <p id="message">Preparing...</p>

        <div id="found-beacons"></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-header" role="tab" id="headingThree">
      <h5 class="mb-0">
        <a class="collapsed" data-toggle="collapse" href="#collapseThree" role="button" aria-expanded="false" aria-controls="collapseThree">
          Generic View
        </a>
      </h5>
    </div>
    <div id="collapseThree" class="collapse" role="tabpanel" aria-labelledby="headingThree" data-parent="#accordion">
      <div class="card-body">
        <div id="deviceready" class="blink">
            <p class="event listening">Connecting to Device</p>
            <p class="event received">Device is Ready</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<footer id="myFooter">
  <div class="container">
    <div class="row">
      <div class="col-sm-12 myCols">
        <h5>Our Team</h5>
        <ul>
          <li>Ammar Al-Kahfah</li>
          <li>Ali Sharaf</li>
          <li>Victor Lourng</li>
          <li>Gregory Kofman</li>
        </ul>
      </div>
    </div>
  </div>
  <div class="social-networks">
    <a href="https://twitter.com/DragonHacksIEEE" target="_blank" class="twitter"><i class="fa fa-twitter"></i></a>
    <a href="https://www.facebook.com/events/1651794458197007/" target="_blank" class="facebook"><i class="fa fa-facebook-official"></i></a>
  </div>
  <div class="footer-copyright">
    <p>Â© 2018 Copyright DragonHacks </p>
  </div>
</footer>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<!-- Google Map Scripts -->
<!-- API KEY: AIzaSyCwsgt4H1TnyCxRx0hirV5tOJrfbAntlTI -->
<!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwsgt4H1TnyCxRx0hirV5tOJrfbAntlTI&callback=myMap"></script> -->
<script>
      var map;
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 39.955112, lng: -75.187941},
          zoom: 19
        });

        var infoMarker = new google.maps.Marker({
          position: {lat: 39.955112, lng: -75.187641},
          map: map,
          title: 'Information Desk'
        });

        var restroomMarker = new google.maps.Marker({
          position: {lat: 39.955152, lng: -75.1882},
          map: map,
          title: 'Restroom'
        });

        infoMarker.addListener('click', function() {
          speak("This is the information desk.");
        });

        restroomMarker.addListener('click', function() {
          speak("This is a restroom.");
        });
      }


</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCM0IACb9WQcWcA2wVvDgdMCwPs58vYNEU&callback=initMap"
    async defer></script>

<!-- Speech to Text Script -->
<script src="js/speechtotextscript.js"></script>

<!-- More Scripts  -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta.3/js/bootstrap.bundle.min.js"></script>

<script>
$(function () {
$('[data-toggle="popover"]').popover()
})
</script>

<!-- Cordova -->
<script src="cordova.js"></script>
<script>
      // Application code starts here. The code is wrapped in a
    // function closure to prevent overwriting global objects.
    (function()
    {
        // Dictionary of beacons.
        var beacons = {};

        // Timer that displays list of beacons.
        var timer = null;
        var timer2 = null;

        function onDeviceReady()
        {
            // Start tracking beacons!
            setTimeout(startScan, 500);

            // Timer that refreshes the display.
            timer = setInterval(updateBeaconList, 500);
            timer2 = setInterval(speakBeacons, 5000);
        }

        function onBackButtonDown()
        {
            evothings.eddystone.stopScan();
            navigator.app.exitApp();
        }

        function startScan()
        {
            showMessage('Scan in progress.');
            evothings.eddystone.startScan(
                function(beacon)
                {
                    // Update beacon data.
                    beacon.timeStamp = Date.now();
                    beacons[beacon.address] = beacon;
                },
                function(error)
                {
                    showMessage('Eddystone scan error: ' + error);
                });
        }

        // Map the RSSI value to a value between 1 and 100.
        function mapBeaconRSSI(rssi)
        {
            if (rssi >= 0) return 1; // Unknown RSSI maps to 1.
            if (rssi < -100) return 100; // Max RSSI
            return 100 + rssi;
        }

        function getSortedBeaconList(beacons)
        {
            var beaconList = [];
            for (var key in beacons)
            {
                beaconList.push(beacons[key]);
            }
            beaconList.sort(function(beacon1, beacon2)
            {
                return mapBeaconRSSI(beacon1.rssi) < mapBeaconRSSI(beacon2.rssi);
            });
            return beaconList;
        }

        function updateBeaconList()
        {
            removeOldBeacons();
            displayBeacons();
        }

        function removeOldBeacons()
        {
            var timeNow = Date.now();
            for (var key in beacons)
            {
                // Only show beacons updated during the last 60 seconds.
                var beacon = beacons[key];
                if (beacon.timeStamp + 60000 < timeNow)
                {
                    delete beacons[key];
                }
            }
        }

        function speakBeacons()
        {
            var sortedList = getSortedBeaconList(beacons);
            for (var i = 0; i < sortedList.length; ++i)
            {
                var beacon = sortedList[i];
                console.log("Comparing " + uint8ArrayToString(beacon.bid) + " to 11 or 00 (x6) and checking parseInt(beacon.rssi) if " + parseInt(beacon.rssi) + " is really >-60" );

                if ( (uint8ArrayToString(beacon.bid) == "11 11 11 11 11 11 ") && (parseInt(beacon.rssi) >= -65) ) {
                  speak("You are near the information desk.");
                }
               else if ( (uint8ArrayToString(beacon.bid) == "00 00 00 00 00 00 ") && (parseInt(beacon.rssi) >= -65) ) {
                  speak("You are near the restrooms.");
                }
                else {
                  // speak("You are not near anything.");
                }
            }
        }

        function displayBeacons()
        {
            var html = '';
            var sortedList = getSortedBeaconList(beacons);
            for (var i = 0; i < sortedList.length; ++i)
            {
                var beacon = sortedList[i];
                var htmlBeacon =
                    '<p>'
                    +   htmlBeaconName(beacon)
                    +   htmlBeaconURL(beacon)
                    +   htmlBeaconNID(beacon)
                    +   htmlBeaconBID(beacon)
                    +   htmlBeaconVoltage(beacon)
                    +   htmlBeaconTemperature(beacon)
                    +   htmlBeaconRSSI(beacon)
                    +   htmlBeaconRSSINearby(beacon)
                    + '</p>';
                html += htmlBeacon
            }
            document.querySelector('#found-beacons').innerHTML = html;
        }

        function htmlBeaconName(beacon)
        {
            var name = beacon.name || 'no name';
            return '<strong>' + name + '</strong><br/>';
        }

        function htmlBeaconURL(beacon)
        {
            return beacon.url ?
                'URL: ' + beacon.url + '<br/>' :  '';
        }

        function htmlBeaconURL(beacon)
        {
            return beacon.url ?
                'URL: ' + beacon.url + '<br/>' :  '';
        }

        function htmlBeaconNID(beacon)
        {
            return beacon.nid ?
                'NID: ' + uint8ArrayToString(beacon.nid) + '<br/>' :  '';
        }

        function htmlBeaconBID(beacon)
        {
            return beacon.bid ?
                'BID: ' + uint8ArrayToString(beacon.bid) + '<br/>' :  '';
        }

        function htmlBeaconBIDRaw(beacon)
        {
            return beacon.bid ?
                'BID: ' + beacon.bid + '<br/>' :  '';
        }

        function htmlBeaconVoltage(beacon)
        {
            return beacon.voltage ?
                'Voltage: ' + beacon.voltage + '<br/>' :  '';
        }

        function htmlBeaconTemperature(beacon)
        {
            return beacon.temperature && beacon.temperature != 0x8000 ?
                'Temperature: ' + beacon.temperature + '<br/>' :  '';
        }

        function htmlBeaconRSSI(beacon)
        {
            return beacon.rssi ?
                'RSSI: ' + beacon.rssi + '<br/>' :  '';
        }

        function htmlBeaconRSSINearby(beacon)
        {
            return (parseInt(beacon.rssi) >= -65) ?
                'Nearby: true' + '<br/>' :  'Nearby: false' + '<br/>';
        }


        function uint8ArrayToString(uint8Array)
        {
            function format(x)
            {
                var hex = x.toString(16);
                return hex.length < 2 ? '0' + hex : hex;
            }

            var result = '';
            for (var i = 0; i < uint8Array.length; ++i)
            {
                result += format(uint8Array[i]) + ' ';
            }
            return result;
        }

        function showMessage(text)
        {
            document.querySelector('#message').innerHTML = text;
        }

        // This calls onDeviceReady when Cordova has loaded everything.
        document.addEventListener('deviceready', onDeviceReady, false);

        // Add back button listener (for Android).
        document.addEventListener('backbutton', onBackButtonDown, false);

    })(); // End of closure.
</script>
<script>
</script>
</body>
</html>
